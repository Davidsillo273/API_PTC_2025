-- Tabla de roles (ej: instructor, coordinator) 

CREATE TABLE tbRoles ( 

    roleId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 

    roleName VARCHAR2(50) NOT NULL 

); 

  

-- Tabla de usuarios 

CREATE TABLE tbUsers ( 

    userId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 

    username VARCHAR2(50) UNIQUE NOT NULL, 

    passwordHash VARCHAR2(255) NOT NULL, 

    fullName VARCHAR2(100), 

    roleId NUMBER, 

    FOREIGN KEY (roleId) REFERENCES tbRoles(roleId) 

); 

  

-- Tabla de tipos de vehículo 

CREATE TABLE tbVehicleTypes ( 

    typeId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 

    typeName VARCHAR2(50) NOT NULL 

); 

  

-- Tabla de vehículos 

CREATE TABLE tbVehicles ( 

    vehicleId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 

    plateNumber VARCHAR2(10) UNIQUE NOT NULL, 

    brand VARCHAR2(50), 

    model VARCHAR2(50), 

    typeId NUMBER, 

    color VARCHAR2(30), 

    circulationCardNumber VARCHAR2(50), 

    vehicleImage BLOB, 

    FOREIGN KEY (typeId) REFERENCES tbVehicleTypes(typeId) 

); 

  

-- Tabla de módulos (por ej. motor, suspensión, etc.) 

CREATE TABLE tbModules ( 

    moduleId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 

    moduleName VARCHAR2(50) NOT NULL 

); 


CREATE TABLE tbModuleOperations ( 

    operationId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 

    moduleId NUMBER NOT NULL, 

    operationName VARCHAR2(100) NOT NULL, 

    FOREIGN KEY (moduleId) REFERENCES tbModules(moduleId) 

); 

  
CREATE TABLE tbWorkOrders (
    workOrderId NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    vehicleId NUMBER NOT NULL,
    academicYear VARCHAR2(20) CHECK (academicYear IN ('FirstYear', 'SecondYear', 'ThirdYear')),
    instructorId NUMBER,
    studentName VARCHAR2(100),
    studentId VARCHAR2(8),
    operationId NUMBER NOT NULL,
    moduleId NUMBER NOT NULL,
    maintenanceType VARCHAR2(20) CHECK (maintenanceType IN ('Preventive', 'Corrective')),
    estimatedTime VARCHAR2(50),
    entryTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    exitTime TIMESTAMP,
    ownerName VARCHAR2(100),
    ownerDui VARCHAR2(10),
    status VARCHAR2(20) DEFAULT 'Pending',
    FOREIGN KEY (vehicleId) REFERENCES tbVehicles(vehicleId),
    FOREIGN KEY (instructorId) REFERENCES tbUsers(userId),
    FOREIGN KEY (moduleId) REFERENCES tbModules(moduleId),
    FOREIGN KEY (operationId) REFERENCES tbModuleOperations(operationId)
);

 

CREATE TABLE tbVehicleEntries ( 

    entryId NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY, 

    vehicleId NUMBER NOT NULL, 

    entryTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP, 

    operationId NUMBER NOT NULL, 

    status VARCHAR2(20) DEFAULT 'Accepted', 

    CONSTRAINT fk_vehicle FOREIGN KEY (vehicleId) REFERENCES tbVehicles(vehicleId), 

    CONSTRAINT fk_operation FOREIGN KEY (operationId) REFERENCES tbModuleOperations(operationId), 

    CONSTRAINT chk_status CHECK (status IN ('Accepted', 'Rejected', 'Pending')) 

); 

 

--vista de detalles de trabajo 

CREATE OR REPLACE VIEW vw_VehicleWorkDetails AS 

SELECT 

    wo.workOrderId AS record, 

    v.brand || ' ' || v.model AS vehicle, 

    v.plateNumber AS plate, 

    wo.studentName AS assignedStudent, 

    m.moduleName AS module, 

    u.fullName AS instructorInCharge, 

    mo.operationName AS task 

FROM 

    tbWorkOrders wo 

    JOIN tbVehicles v ON wo.vehicleId = v.vehicleId 

    JOIN tbModules m ON wo.moduleId = m.moduleId 

    JOIN tbModuleOperations mo ON wo.operationId = mo.operationId 

    LEFT JOIN tbUsers u ON wo.instructorId = u.userId; 

 

--vista de trabajos activos pendientes 

 CREATE OR REPLACE VIEW vw_ActiveWorkOrders AS 

SELECT 

    wo.academicYear AS academicYear, 

    wo.workOrderId AS record, 

    v.brand || ' ' || v.model AS vehicle, 

    v.vehicleImage AS vehicleImage, 

    mo.operationName AS performedTask, 

    wo.exitTime AS exitTime 

FROM 

    tbWorkOrders wo 

    JOIN tbVehicles v ON wo.vehicleId = v.vehicleId 

    JOIN tbModuleOperations mo ON wo.operationId = mo.operationId 

WHERE 

    wo.status = 'Pending'; 

 

--vista seguimiento de trabajo 

CREATE OR REPLACE VIEW vwSeguimientoTrabajo AS 

SELECT 

    wo.workOrderId AS trabajo_id, 

    wo.estimatedTime AS tiempo_estimado, 

    wo.exitTime - SYSTIMESTAMP AS tiempo_restante, 

    v.brand || ' ' || v.model AS carro, 

    mo.operationName AS trabajo, 

    v.plateNumber AS placa, 

    wo.studentName AS estudiante_asignado, 

    m.moduleName AS modulo, 

    u.fullName AS instructor 

FROM 

    tbWorkOrders wo 

    JOIN tbVehicles v ON wo.vehicleId = v.vehicleId 

    JOIN tbModuleOperations mo ON wo.operationId = mo.operationId 

    JOIN tbModules m ON wo.moduleId = m.moduleId 

    LEFT JOIN tbUsers u ON wo.instructorId = u.userId 

WHERE 

    wo.status = 'Accepted'; 

 

--procedure aceptar ingreso de vehículo 

CREATE OR REPLACE PROCEDURE aceptar_ingreso( 

    p_vehicleId IN NUMBER, 

    p_operationId IN NUMBER 

) 

AS 

BEGIN 

    INSERT INTO tbVehicleEntries ( 

        vehicleId, 

        operationId, 

        status 

    ) VALUES ( 

        p_vehicleId, 

        p_operationId, 

        'Accepted' 

    ); 

 

    COMMIT; 

END; 

/ 

 

--comentarios de tablas 

COMMENT ON TABLE tbRoles IS 'Tabla de roles'; 

COMMENT ON TABLE tbUsers IS 'Tabla de usuarios del sistema'; 

COMMENT ON TABLE tbVehicleTypes IS 'Tipos de vehículos disponibles'; 

COMMENT ON TABLE tbVehicles IS 'Registro de vehículos con sus datos'; 

COMMENT ON TABLE tbModules IS 'Módulos de trabajo'; 

COMMENT ON TABLE tbWorkOrders IS 'Órdenes de trabajo registradas para mantenimiento o reparación'; 

COMMENT ON TABLE tbModuleOperations IS 'Trabajos de modulo especificos'; 

COMMENT ON TABLE tbVehicleEntries IS 'Registro de ingreso de vehículos'; 

 

 

--comentarios de columnas 

--tbRoles 

COMMENT ON COLUMN tbRoles.roleId IS 'Identificador único del rol'; 

COMMENT ON COLUMN tbRoles.roleName IS 'Nombre del rol'; 

--tbUsers 

COMMENT ON COLUMN tbUsers.userId IS 'Identificador único del usuario'; 

COMMENT ON COLUMN tbUsers.username IS 'Nombre de usuario único para iniciar sesión'; 

COMMENT ON COLUMN tbUsers.passwordHash IS 'Contraseña'; 

COMMENT ON COLUMN tbUsers.fullName IS 'Nombre completo del usuario'; 

COMMENT ON COLUMN tbUsers.roleId IS 'Rol asignado al usuario (FK a tbRoles)'; 

--tbVehicleTypes 

COMMENT ON COLUMN tbVehicleTypes.typeId IS 'Identificador único del tipo de vehículo'; 

COMMENT ON COLUMN tbVehicleTypes.typeName IS 'Nombre del tipo de vehículo'; 

--tbVehicles 

COMMENT ON COLUMN tbVehicles.vehicleId IS 'Identificador único del vehículo'; 

COMMENT ON COLUMN tbVehicles.plateNumber IS 'Número de placa del vehículo'; 

COMMENT ON COLUMN tbVehicles.brand IS 'Marca del vehículo'; 

COMMENT ON COLUMN tbVehicles.model IS 'Modelo del vehículo'; 

COMMENT ON COLUMN tbVehicles.typeId IS 'Tipo de vehículo (FK a tbVehicleTypes)'; 

COMMENT ON COLUMN tbVehicles.color IS 'Color del vehículo'; 

COMMENT ON COLUMN tbVehicles.circulationCardNumber IS 'Número de la tarjeta de circulación del vehículo'; 

COMMENT ON COLUMN tbVehicles.vehicleImage IS 'Imagen del vehículo'; 

--tbModules 

COMMENT ON COLUMN tbModules.moduleId IS 'Identificador único del módulo'; 

COMMENT ON COLUMN tbModules.moduleName IS 'Nombre del módulo'; 

--DbModuleOperations 

COMMENT ON COLUMN tbModuleOperations.operationId IS 'Identificador único de la operación'; 

COMMENT ON COLUMN tbModuleOperations.moduleId IS 'Módulo al que pertenece la operación (FK a tbModules)'; 

COMMENT ON COLUMN tbModuleOperations.operationName IS 'Nombre de la operación que se realiza en el módulo'; 

--tbWorkOrders 

COMMENT ON COLUMN tbWorkOrders.workOrderId IS 'Identificador único de la orden de trabajo'; 

COMMENT ON COLUMN tbWorkOrders.vehicleId IS 'Vehículo asociado a la orden (FK a tbVehicles)'; 

COMMENT ON COLUMN tbWorkOrders.academicYear IS 'Año académico correspondiente a la práctica'; 

COMMENT ON COLUMN tbWorkOrders.instructorId IS 'Usuario instructor encargado (FK a tbUsers)'; 

COMMENT ON COLUMN tbWorkOrders.studentName IS 'Nombre del estudiante asignado al trabajo'; 

COMMENT ON COLUMN tbWorkOrders.studentId IS 'ID del estudiante asignado'; 

COMMENT ON COLUMN tbWorkOrders.operationId IS 'ID de la operación realizada (FK a tbModuleOperations)'; 

COMMENT ON COLUMN tbWorkOrders.moduleId IS 'Módulo asociado al trabajo (FK a tbModules)'; 

COMMENT ON COLUMN tbWorkOrders.maintenanceType IS 'Tipo de mantenimiento: Preventivo o Correctivo'; 

COMMENT ON COLUMN tbWorkOrders.estimatedTime IS 'Tiempo estimado para completar el trabajo'; 

COMMENT ON COLUMN tbWorkOrders.entryTime IS 'Fecha y hora de ingreso del vehículo'; 

COMMENT ON COLUMN tbWorkOrders.exitTime IS 'Fecha y hora estimada o real de salida del vehículo'; 

COMMENT ON COLUMN tbWorkOrders.ownerName IS 'Nombre del propietario del vehículo'; 

COMMENT ON COLUMN tbWorkOrders.ownerDui IS 'Número de DUI del propietario'; 

COMMENT ON COLUMN tbWorkOrders.status IS 'Estado de la orden: Pending, Accepted o Completed'; 

--tbVehicleEntries 

COMMENT ON COLUMN tbVehicleEntries.entryId IS 'Identificador único de ingreso'; 

COMMENT ON COLUMN tbVehicleEntries.vehicleId IS 'ID del vehículo ingresado (FK a tbVehicles)'; 

COMMENT ON COLUMN tbVehicleEntries.entryTime IS 'Fecha y hora del ingreso del vehículo'; 

COMMENT ON COLUMN tbVehicleEntries.operationId IS 'ID de la operación a realizar (FK a tbModuleOperations)'; 

COMMENT ON COLUMN tbVehicleEntries.status IS 'Estado del ingreso: Accepted, Rejected o Pending'; 